# CakePHP RestKit plugin

An attempt to create a decent JSON-only plugin for CakePHP.

## Version ##

This plugin is heavily under construction so do not use it unless you value your production environment ;)

Please note:

* support for XML is dropped, JSON only from now on
* added Basic authentication (enable in the config, docs will follow)
* added deny-all-except-granted when authentication is on (docs will follow)

## Features

* rich REST errors with autogenerated moreInfo links
* custom HTTP Status Codes
* vaidation rules for URI parameters
* version prefixing (e.g. /v1/)

## Requirements

The RestKit plugin requires CakePHP 2.4 or higher

## Installation

Clone the repository into /app/Plugin/RestKit:

     git submodule add git://github.com/bravo-kernel/cakephp-restkit.git Plugin/RestKit

Make sure the Exception class is loaded /app/Controller/AppController.php:

    App::uses('RestKitException', 'Plugin/RestKit/Lib/Error/Exception');

Load the following components in /app/Controller/AppController.php

    public $components = array(
        'RequestHandler',
	 'Auth' => array(
             'authenticate' => array(
                 'Basic' => array(
                 'fields' => array('username' => 'username')))),
        'RestKit.RestKit');

Enable the RestKit plugin in /app/Config/bootstrap.php:

    CakePlugin::load(array(
        'RestKit' => array('bootstrap' => true, 'routes' => true),
    ));

Disable CakePHP default routing in /app/Config/routes.php:

    //require CAKE . 'Config' . DS . 'routes.php';


# Documentation

## Configuration

All options can be configurated by editing /app/Plugin/RestKit/Config/config.php.

* **enableOptionValidation**: set to 'true' to turn validation on
* HTTP Status Codes

## Usage

### JSON rendering

This plugin uses Cake's JSONView so no need to create any view files as described
perfectly here: http://api20.cakephp.org/class/json-view. Just use something like:

    $this->set(array('posts' => $posts, '_serialize' => 'posts'));

or this if you need an enclosing tag

    $this->set(compact('posts', 'users', 'stuff'));
    $this->set('_serialize', array('posts', 'users'));

### Default Exceptions

RestKit uses the RestKitExceptionRenderer to respond with REST errors containing
rich error information and corresponding HTTP Status Codes.

Please note that behavior in non-debug-mode is different than that of Cake (returning only
the 404 and 500 errors) in that the response will contain:
* the actual HTTP Status Code
* the actual HTTP Status Code description
* an error message reset to the description of the HTTP Status Code to prevent
any sensitive information from becoming public

**ForbiddenException() example**

    <response>
        <status>403</status>
        <message>Forbidden</message>
        <code>403</code>
        <moreInfo>http:///www.bravo-kernel.com/docs/errors/403</moreInfo>
     </response>

**Programming error in debug mode**

    <response>
        <status>500</status>
        <message>Internal Server Error</message>
        <code>500</code>
        <moreInfo>http:///www.bravo-kernel.com/docs/errors/500</moreInfo>
    </response>

**Programming error in non-debug mode**

    <response>
        <status>500</status>
        <message>
            Call to undefined method RestKitComponent::crashMe()
        </message>
        <code>500</code>
        <moreInfo>http:///www.bravo-kernel.com/docs/errors/500</moreInfo>
    </response>

### RestKitExceptions

RestKitExceptions are useful if you want to provide informational feedback about your application's
internal usage because the passed error messages will appear in both debug and non-debug mode.

RestKitExceptions use HTTP Status Code 500 but you can use custom HTTP Status Code and descriptions
as well. Please note that custom HTTP Status Codes must be defined in /RestKit/Config/config.php or
they will be ignored.

**throw new RestKitException();**

    <response>
        <status>500</status>
        <message>RestKit Error</message>
        <code>500</code>
        <moreInfo>http://www.bravo-kernel.com/docs/errors/500</moreInfo>
    </response>

**throw new RestKitException('Invalid Phone Number');**

    <response>
        <status>500</status>
        <message>Invalid phone number</message>
        <code>500</code>
        <moreInfo>http://www.bravo-kernel.com/docs/errors/500</moreInfo>
    </response>

**throw new RestKitException('Invalid Phone Number', 666);**

    <response>
        <status>666</status>
        <message>Invalid phone number</message>
        <code>666</code>
        <moreInfo>http://www.bravo-kernel.com/docs/errors/666</moreInfo>
    </response>

**throw new RestKitException('Invalid Phone Number', 12004);**

    <response>
        <status>500</status>
        <message>Invalid phone number</message>
        <code>12004</code>
        <moreInfo>http://www.bravo-kernel.com/docs/errors/12004</moreInfo>
    </response>

### Validating query parameters

All APIs need support for query parameters so that users can manipulate the results
using simple URL arguments. For those unfamiliar with query parameters take a look
at the following examples:

 * my.domain.com/users**?order=asc**
 * my.domain.com/users**?limit=10**
 * my.domain.com/users**?order=asc&limit=10**

RestKit provides out-of-the-box validation for a set of the most commonly used query parameters
so you can protect your API against stuff like SQL-injections and what have not. Currently the following
 query parameters are implemented:

* **sort** allow either 'asc' or 'desc'
* **limit** allow numeric only

**hasOption():**

    if ($this->RestKit->hasOption('order')){
        echo "Query parameter 'order' contains a value";
    }

**validateOption():**

    if ($this->RestKit->validateOption('order')){
        echo "Value for parameter 'order' was either exactly asc or desc";
    }

**validOption():**

validOption() is a shorthand function that calls both hasOption() and validateOption().

    if ($this->RestKit->validOption('limit')){
        echo "The value for 'limit' exists and is definitely numeric'";
    }

** validationErrors:**

If validation fails you can access the validation errors using $this->RestKit->validationErrors.

    if (!$this->RestKit->validOption('limit')){
        pr($this->RestKit->validationErrors);
    }

# TODO

* refactor Exceptions debug information
* make default RestKit HTTP Status Code description a configuration option
* normalize html error responses (now share REST logic)
* implement [REST Maturity Levels](http://martinfowler.com/articles/richardsonMaturityModel.html)
* add security (deny all unless authorized)
* add OAuth token handling (will require a separate app with OAuth server and login functionality)
* add an extra 'exception' tag for returned error XML (requires overriding default XmlView somehow)
* make prefixed route exclusive when enabled (making the default (direct) Cake routes to the controllers no longer available)
